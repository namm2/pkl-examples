import "package://pkg.pkl-lang.org/pkl-k8s/k8s@1.0.1#/K8sResource.pkl"
import "package://pkg.pkl-lang.org/pkl-k8s/k8s@1.0.1#/api/apps/v1/Deployment.pkl"
import "package://pkg.pkl-lang.org/pkl-k8s/k8s@1.0.1#/api/core/v1/Service.pkl"

resources: Listing<K8sResource> = new {
	new Deployment {
		metadata {
			name = "pkl-demo"
			namespace = "test"
			labels {
				["ct_team"] = "cloud-tools"
				["app"] = "guestbook"
				["tier"] = "frontend"
			}
		}
		spec {
			selector {
				matchLabels {
					["app"] = "guestbook"
					["tier"] = "frontend"
				}
			}
			replicas = 3
			template {
				metadata {
					labels {
						["app"] = "guestbook"
						["tier"] = "frontend"
					}
				}
				spec {
					containers {
						new {
							name = "gb-frontend"
							image = "gcr.io/google-samples/gb-frontend:v4"
							env {
								new {
									name = "GET_HOSTS_FROM"
									value = "dns"
								}
							}
							ports {
								new {
									containerPort = 8080
								}
							}
						}
					}
				}
			}
		}
	}

	new Service {
		metadata {
			name = "pkl-demo"
			namespace = "test"
		}
		spec {
			selector {
				["app"] = "guestbook"
				["tier"] = "frontend"
			}
		}
	}
}

output {
	value = resources
	renderer = (K8sResource.output.renderer as YamlRenderer) {
		isStream = true
	}
}
